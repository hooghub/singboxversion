name: Update sing-box cores

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *"  # 每天 UTC 03:00 自动检查一次（你可改）
  push:
    paths:
      - ".github/workflows/update-singbox.yml"

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch latest sing-box release info
        id: latest
        uses: actions/github-script@v7
        with:
          script: |
            const rel = await github.rest.repos.getLatestRelease({
              owner: "SagerNet",
              repo: "sing-box"
            });
            core.setOutput("tag", rel.data.tag_name); // e.g. v1.11.0
            console.log("Latest tag:", rel.data.tag_name);

      - name: Download and extract cores
        run: |
          set -e
          TAG="${{ steps.latest.outputs.tag }}"
          VER="${TAG#v}"

          mkdir -p bin /tmp/sb

          curl -fL "https://github.com/SagerNet/sing-box/releases/download/${TAG}/sing-box-${VER}-linux-amd64.tar.gz" -o /tmp/sb/amd64.tgz
          curl -fL "https://github.com/SagerNet/sing-box/releases/download/${TAG}/sing-box-${VER}-linux-arm64.tar.gz" -o /tmp/sb/arm64.tgz

          tar -xzf /tmp/sb/amd64.tgz -C /tmp/sb
          install -m 755 /tmp/sb/sing-box-${VER}-linux-amd64/sing-box bin/sing-box-linux-amd64

          rm -rf /tmp/sb/sing-box-${VER}-linux-amd64
          tar -xzf /tmp/sb/arm64.tgz -C /tmp/sb
          install -m 755 /tmp/sb/sing-box-${VER}-linux-arm64/sing-box bin/sing-box-linux-arm64

          echo "${TAG}" > bin/VERSION

      - name: Commit & push if changed
        run: |
          set -e
          git config user.name "singbox-bot"
          git config user.email "singbox-bot@users.noreply.github.com"

          git add bin/sing-box-linux-amd64 bin/sing-box-linux-arm64 bin/VERSION

          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi

          TAG="$(cat bin/VERSION)"
          git commit -m "chore: update sing-box cores to ${TAG}"
          git push
